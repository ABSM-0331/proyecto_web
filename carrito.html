<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Gamer Zone</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/style.css"> 
</head>

<body>
    <div class="alumnos-info container-fluid">
        <div class="container">
            <p>Proyecto de DiseÃ±o Web. Alumnos:</p>
            <p>Jorge Rafid Medina Porras | Miguel Moises Olivares Novelo | Rudy Daniel Navarrete Catzin</p>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="inicio.html">ðŸŽ® Gamer Zone</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="inicio.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="noticias.html">Noticias</a></li>
                    <li class="nav-item"><a class="nav-link" href="ofertas.html">Ofertas</a></li>
                    <li class="nav-item"><a class="nav-link" href="sobre-nosotros.html">Sobre Nosotros</a></li>
                    <li class="nav-item">
                        <a class="nav-link active position-relative" href="carrito.html">
                            <i class="bi bi-cart-fill"></i> Carrito
                            <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                0 
                                <span class="visually-hidden">items en el carrito</span>
                            </span>
                        </a>
                    </li> 
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h1 class="section-title text-center animate-on-scroll">ðŸ›’ Carrito de Compras</h1>

        <div id="loading-state" class="text-center py-3 mb-5 animate-on-scroll" 
             style="height: 350px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
             
             <div class="animated-cart-container text-warning">
                <i class="bi bi-cart-fill"></i>
            </div>
            
            <p class="my-5 fs-5 text-white loading-text">Esperando compras...</p>
        </div>
        
        <section id="cart-content" class="py-3 animate-on-scroll" style="display: none;">
            <div class="row">
                <div class="col-lg-8">
                    <h3 class="text-warning mb-3">Productos Agregados</h3>
                    
                    <div id="contenedor-productos"></div>
                </div>

                <div class="col-lg-4">
                    <div class="card p-4 sticky-top bg-dark text-white" style="top: 80px;">
                        <h4 class="text-warning">Resumen del Pedido</h4>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center text-white bg-transparent">
                                Subtotal: <span id="cart-subtotal">MXN $0.00</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center text-white bg-transparent">
                                Costo de EnvÃ­o: <span id="cart-envio">MXN $150.00</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center text-white fw-bold border-top border-warning bg-transparent mt-2 pt-2">
                                Total Final: <span class="fs-5 text-warning" id="cart-total">MXN $150.00</span>
                            </li>
                        </ul>
                        <button onclick="procederPago()" class="btn btn-warning btn-lg mt-3 fw-bold w-100">Proceder al Pago</button>
                    </div>
                </div>
            </div>
        </section>

    </div> 

    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h5>ðŸŽ® Gamer Zone</h5>
                    <p>La mejor tienda online de videojuegos y accesorios.</p>
                    <p><i class="bi bi-geo-alt-fill me-2"></i> Calle Principal #123, Ciudad Gamer</p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Enlaces RÃ¡pidos</h5>
                    <ul class="list-unstyled">
                        <li><a href="productos.html" class="text-white text-decoration-none">CatÃ¡logo Completo</a></li>
                        <li><a href="ofertas.html" class="text-white text-decoration-none">Ver Ofertas</a></li>
                        <li><a href="noticias.html" class="text-white text-decoration-none">Ãšltimas Noticias</a></li>
                        <li><a href="sobre-nosotros.html" class="text-white text-decoration-none">Sobre Nosotros</a></li>
                        <li><a href="login.html" class="text-white text-decoration-none">Mi Cuenta</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>SÃ­guenos</h5>
                    <a href="#" class="text-white me-3"><i class="bi bi-facebook fs-4"></i></a>
                    <a href="#" class="text-white me-3"><i class="bi bi-twitter fs-4"></i></a>
                    <a href="#" class="text-white"><i class="bi bi-instagram fs-4"></i></a>
                </div>
            </div>
            <div class="row">
                <div class="col-12 text-center pt-3 border-top border-light opacity-50">
                    <p class="mb-0">&copy; 2025 Gamer Zone. Todos los derechos reservados. | Proyecto de DiseÃ±o Web.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/sesion.js"></script> 

    <script>
        function checkVisibility() {
            const elements = document.querySelectorAll('.animate-on-scroll');
            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                if (rect.top < window.innerHeight - 100) {
                    element.classList.add('is-visible');
                }
            });
        }
        window.addEventListener('load', checkVisibility);
        window.addEventListener('scroll', checkVisibility);
    </script>
    
    <script>
        const CART_KEY = 'carrito';
        const STOCK_KEY = 'stockInventario';

        // ----------------------------------------------------------------------
        // SIMULACIÃ“N DE INVENTARIO MAESTRO (STOCK)
        // ----------------------------------------------------------------------
        function inicializarStock() {
            let stock = localStorage.getItem(STOCK_KEY);
            if (!stock) {
                // Inventario Maestro (Solo se crea la primera vez)
                const masterStock = {
                    // Digitales
                    'Cyberpunk 2077': 999, 'NBA 2K25': 999, 'DOOM: The Dark Ages': 999, 'God of War: RagnarÃ¶k': 999, 'Marvel 1943': 999, 'Super Mario Bros Wonder': 999, 'Spider-Man 2': 999, 'Death Stranding 2': 999, 'Elden Ring (Digital)': 999, 'Grand Theft Auto VI': 999, 'Hogwarts Legacy': 999, 'The Last of Us Parte I': 999, 'Resident Evil 4 Remake': 999, 'Fortnite (Paquete Premium)': 999, 'Call of Duty Modern Warfare III': 999, 'Mortal Kombat 1': 999,
                    // FÃ­sicos (Detalle)
                    'Super Smash Bros Ultimate': 45, 'Elden Ring': 70, 'The Last of Us Part II Remastered': 50, 'Metroid Dread': 28, 'Forza Horizon 5': 60, 'Splatoon 3': 40, 'Star Wars Jedi: Survivor': 34, 'PokÃ©mon Scarlet': 56, 'Assassin\'s Creed Mirage': 39, 'Sonic Frontiers': 48, 'Dragon Ball Z: Kakarot': 42, 'Luigiâ€™s Mansion 3': 37,
                    // Ofertas
                    'Marvel\'s Guardians of the Galaxy': 50, 'Kirby and the Forgotten Land - Standard Edition': 15, 'Horizon Forbidden West': 30, 'God of War RagnarÃ¶k (Oferta)': 40, 'Combo Consola PlayStation 5': 10, 'Nintendo Switch OLED + Mario Kart 8': 10, 'Forza Horizon 5 Deluxe': 25, 'Razer Huntsman Mini': 18, 'HyperX Cloud Alpha': 22, 'Logitech G502 HERO': 30, 'Nanoleaf RGB Triangles Pack': 15, 'Resident Evil 4 Remake â€“ Deluxe Edition': 25,
                    // Consolas (Detalle)
                    'PlayStation Portal': 35, 'ROG Ally X': 28, 'Atari VCS 2025': 18, 'SEGA Mega Drive Mini 2': 22, 'Analogue Pocket': 32, 'Evercade EXP': 27, 'Playdate': 14, 'Logitech G Cloud': 19, 'Ayn Odin 2': 26, 'Retroid Pocket 4 Pro': 30,
                    // Componentes (Detalle)
                    'Ryzen 7 7800X3D': 25, 'Intel Core i7-14700K': 18, 'NVIDIA RTX 4070 Super': 12, 'AMD Radeon RX 7800 XT': 20, 'MSI B650 Tomahawk WiFi': 30, 'Gigabyte Z790 Aorus Elite': 22, 'Corsair Vengeance DDR5 32GB': 40, 'Kingston NV2 2TB M.2 SSD': 55, 'Cooler Master 750W Gold': 34, 'Noctua NH-D15 Chromax Black': 15, 'Samsung 990 PRO 1TB': 45, 'NZXT H7 Flow': 16,
                    // Accesorios (Detalle)
                    'Arctis Nova Pro Wireless': 20, 'Logitech G Pro X Superlight 2': 35, 'Razer Huntsman V3 Pro': 18, 'ASUS ROG Throne Qi': 18, 'Razer Seiren Mini': 35, 'Logitech Litra Glow': 20, 'Razer Firefly V2': 25, 'Xbox Elite Series 2 Core': 30, 'PS5 Media Remote': 28, 'DualSense Charging Station': 22, 'HyperX Wrist Rest': 45, 'Elgato Stream Deck MK2': 25,
                    // Muestras de productos.html
                    'Cyberpunk 2077 (Muestra)': 999, 'NBA 2K25 (Muestra)': 999, 'DOOM: The Dark Ages (Muestra)': 999, 'God of War: RagnarÃ¶k (Muestra)': 999, 'Marvel 1943: Rise of Hydra (Muestra)': 999, 'Super Mario Bros. Wonder (Muestra)': 999, 'Marvel\'s Spider-Man 2 (Muestra)': 999, 'Death Stranding 2: On the Beach (Muestra)': 999,
                    'Mario Kart 8 Deluxe (Muestra)': 20, 'WWE 2K25 (Muestra)': 3, 'Grand Theft Auto V (Muestra)': 100, 'Minecraft (Muestra)': 300, 'Red Dead Redemption 2 (Muestra)': 78, 'Madden NFL 25 (Muestra)': 63, 'Animal Crossing: New Horizons (Muestra)': 80, 'Call of Duty: Black Ops 6 (Muestra)': 2,
                    'PlayStation 5 (E. EstÃ¡ndar Muestra)': 10, 'Xbox Series X (Muestra)': 7, 'Nintendo Switch (OLED Muestra)': 15, 'Xbox Series S (Muestra)': 12, 'Nintendo Switch Lite (Muestra)': 8, 'PlayStation 5 Pro (Muestra)': 5,
                    'Tarjeta GrÃ¡fica RTX 4070 (Muestra)': 10, 'Silla Gamer ErgonÃ³mica Pro (Muestra)': 20, 'Procesador AMD Ryzen 7 7800X3D (Muestra)': 15, 'Placa Base MSI MAG B850 (Muestra)': 12,
                    'Nintendo Mario Silver Edition (Muestra)': 50, 'Control PS5 Spider-Man (Muestra)': 5, 'Arctis Pro Wireless (Muestra)': 10, 'Mouse Razer DeathAdder V3 (Muestra)': 15, 'Teclado HONGLONG (Muestra)': 20, 'Monitor UltraGear 27\'\' (Muestra)': 8, 'Xbox Elite Wireless (Muestra)': 12, 'Luces LED Govee (Muestra)': 30,
                };
                localStorage.setItem(STOCK_KEY, JSON.stringify(masterStock));
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            inicializarStock();
            cargarCarrito();
        });

        function actualizarBadge() {
            let carrito = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            const badge = document.getElementById('cart-badge');
            if (badge) {
                // Suma la cantidad de TODOS los productos, no solo el nÃºmero de tipos
                let totalItems = carrito.reduce((total, prod) => total + prod.cantidad, 0);
                badge.innerText = totalItems;
            }
        }

        function cargarCarrito() {
            let carrito = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            
            const loadingState = document.getElementById('loading-state');
            const cartContent = document.getElementById('cart-content');
            const contenedorProductos = document.getElementById('contenedor-productos');

            if (carrito.length === 0) {
                loadingState.style.display = 'flex';
                cartContent.style.display = 'none';
                actualizarBadge();
                return;
            }

            loadingState.style.display = 'none';
            cartContent.style.display = 'block';

            contenedorProductos.innerHTML = '';
            let subtotal = 0;

            carrito.forEach((prod, index) => {
                let totalProd = prod.precio * prod.cantidad;
                subtotal += totalProd;

                const div = document.createElement('div');
                div.className = "card mb-3 p-3 d-flex flex-row align-items-center";
                div.innerHTML = `
                    <img src="${prod.imagen}" alt="${prod.nombre}" style="width: 80px; height: 80px; object-fit: cover;" class="rounded me-3">
                    <div class="flex-grow-1">
                        <h5>${prod.nombre}</h5>
                        <p class="mb-0 small text-muted">Unitario: MXN $${prod.precio.toLocaleString()}</p>
                    </div>
                    <div class="d-flex align-items-center me-4">
                        <label class="me-2 small">Cant:</label>
                        <input type="number" min="1" value="${prod.cantidad}" 
                            onchange="actualizarCantidad(${index}, this.value)"
                            class="form-control form-control-sm bg-dark text-white border-warning" style="width: 60px;">
                    </div>
                    <h5 class="text-warning me-4 mb-0">MXN $${totalProd.toLocaleString()}</h5>
                    <button onclick="eliminarProducto(${index})" class="btn btn-danger btn-sm"><i class="bi bi-x-lg"></i></button>
                `;

                contenedorProductos.appendChild(div);
            });

            // Actualizar totales
            const costoEnvio = 150;
            const total = subtotal + costoEnvio;

            document.getElementById('cart-subtotal').innerText = `MXN $${subtotal.toLocaleString()}`;
            document.getElementById('cart-total').innerText = `MXN $${total.toLocaleString()}`;
            
            actualizarBadge();
        }

        function actualizarCantidad(index, nuevaCantidad) {
            let carrito = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            let cantidad = parseInt(nuevaCantidad);
            
            if (cantidad < 1) cantidad = 1;
            
            const key = carrito[index].key || carrito[index].nombre;
            let stockInventario = JSON.parse(localStorage.getItem(STOCK_KEY));
            const stockDisponible = stockInventario[key] || 0;

            if (cantidad > stockDisponible) {
                alert(`âŒ No puedes agregar mÃ¡s de ${stockDisponible} unidades de este producto.`);
                cantidad = stockDisponible;
            }

            carrito[index].cantidad = cantidad;
            localStorage.setItem(CART_KEY, JSON.stringify(carrito));
            cargarCarrito();
        }

        function eliminarProducto(index) {
            let carrito = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            carrito.splice(index, 1);
            localStorage.setItem(CART_KEY, JSON.stringify(carrito));
            cargarCarrito();
        }
        
        // FUNCIÃ“N PRINCIPAL DE PAGO: REDUCE EL STOCK
        function procederPago() {
            let carrito = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            let stockInventario = JSON.parse(localStorage.getItem(STOCK_KEY));

            if (carrito.length === 0) {
                alert("Tu carrito estÃ¡ vacÃ­o. Â¡AÃ±ade productos antes de pagar!");
                return;
            }

            let productosComprados = [];

            // 1. Reducir el stock por cada artÃ­culo comprado
            carrito.forEach(prod => {
                const key = prod.key || prod.nombre;
                if (stockInventario[key] !== undefined) {
                    stockInventario[key] -= prod.cantidad;
                    productosComprados.push(`${prod.nombre} x${prod.cantidad}`);
                }
            });

            // 2. Guardar el nuevo stock
            localStorage.setItem(STOCK_KEY, JSON.stringify(stockInventario));

            // 3. Vaciar el carrito
            localStorage.removeItem(CART_KEY);
            
            // 4. Actualizar la vista del carrito (mostrarÃ¡ vacÃ­o)
            cargarCarrito(); 

            alert(`ðŸŽ‰ Â¡Pago completado! Se compraron:\n${productosComprados.join('\n')}\n\nEl inventario (stock simulado) ha sido actualizado.`);
            
            // 5. RedirecciÃ³n simulada
            window.location.href = "login.html";
        }
    </script>
</body>
</html>