<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra | Gamer Zone</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* Estilos espec√≠ficos para la p√°gina de login/registro */
        body {
            background-color: #1a1a1a;
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Estilo para el contenedor del formulario */
        .login-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }

        /* Estilo para la tarjeta del formulario - AUMENTADO PARA CABER DATOS DE PAGO */
        .login-card {
            background-color: #121212;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 650px;
            width: 100%;
        }

        /* T√≠tulo del formulario */
        .login-card h2 {
            color: #ff9800;
            margin-bottom: 30px;
            font-weight: bold;
            text-align: center;
        }

        /* Estilos de inputs oscuros */
        .form-control {
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: #f0f0f0;
        }

        .form-control::placeholder {
            color: #888;
        }

        /* Estilo del bot√≥n Aceptar (Naranja) */
        .btn-accept {
            background-color: #ff9800;
            border-color: #ff9800;
            color: #121212;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-accept:hover {
            background-color: #ffb74d;
            border-color: #ffb74d;
            color: #121212;
        }

        /* Separador de secciones */
        .section-separator {
            border-top: 1px dashed #444;
            margin: 30px 0;
        }

        /* Estilos para el Modal (Ventana emergente) */
        .modal-content {
            background-color: #121212;
            color: #f0f0f0;
            border: 1px solid #ff9800;
        }

        .modal-header {
            border-bottom: 1px solid #ff9800;
        }

        .modal-title {
            color: #ff9800;
        }

        .modal-body strong {
            color: #ffb74d;
        }

        .btn-close {
            filter: invert(1);
            /* Hace que la X del modal sea visible en fondo oscuro */
        }
    </style>
</head>

<body>
    <div class="alumnos-info container-fluid">
        <div class="container">
            <p>Proyecto de Dise√±o Web. Alumnos:</p>
            <p>Jorge Rafid Medina Porras | Miguel Moises Olivares Novelo | Rudy Daniel Navarrete Catzin</p>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">üéÆ Gamer Zone</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="productos.html">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="noticias.html">Noticias</a></li>
                    <li class="nav-item"><a class="nav-link" href="ofertas.html">Ofertas</a></li>
                    <li class="nav-item"><a class="nav-link" href="sobre-nosotros.html">Sobre Nosotros</a></li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="carrito.html">
                            <i class="bi bi-cart-fill"></i> Carrito
                            <span
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                3
                                <span class="visually-hidden">items en el carrito</span>
                            </span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="login-container">
        <div class="login-card animate-on-scroll is-visible">
            <h2>üõí Confirmaci√≥n de Pedido y Pago</h2>

            <form id="registroForm">

                <h4 class="text-warning mb-3"><i class="bi bi-person-fill me-2"></i> Datos de Cuenta y Env√≠o</h4>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="nombres" class="form-label">Nombres</label>
                        <input type="text" class="form-control" id="nombres" required>
                    </div>
                    <div class="col-md-6">
                        <label for="apellidos" class="form-label">Apellidos</label>
                        <input type="text" class="form-control" id="apellidos" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="direccion" class="form-label">Direcci√≥n Completa</label>
                    <input type="text" class="form-control" id="direccion"
                        placeholder="Calle, n√∫mero, colonia, CP, Ciudad" required>
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">Correo Electr√≥nico</label>
                    <input type="email" class="form-control" id="email" required>
                    <div class="form-text">Usaremos este correo para confirmar tu pedido y crear tu cuenta.</div>
                </div>

                <div class="mb-4" id="passwordGroup">
                    <label for="password" class="form-label">Contrase√±a de la Nueva Cuenta</label>
                    <input type="password" class="form-control" id="password" required minlength="8">
                    <div class="form-text text-warning" id="loggedMessage" style="display:none;">
                        Ya has iniciado sesi√≥n. No necesitas reingresar la contrase√±a.
                    </div>
                </div>

                <div class="section-separator"></div>

                <h4 class="text-warning mb-3"><i class="bi bi-credit-card-fill me-2"></i> Datos de Pago (Tarjeta)</h4>

                <div class="mb-3">
                    <label for="nombre_titular_tarjeta" class="form-label">Nombre del Titular (en Tarjeta)</label>
                    <input type="text" class="form-control" id="nombre_titular_tarjeta" required
                        placeholder="Tal como aparece en la tarjeta">
                </div>

                <div class="mb-3">
                    <label for="numero_tarjeta" class="form-label">N√∫mero de Tarjeta</label>
                    <input type="text" class="form-control" id="numero_tarjeta" required minlength="16" maxlength="16"
                        placeholder="Ej: 4111222233334444">
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="caducidad_tarjeta" class="form-label">Fecha de Caducidad</label>
                        <input type="text" class="form-control" id="caducidad_tarjeta" required minlength="5"
                            maxlength="5" placeholder="MM/AA">
                    </div>
                    <div class="col-md-6">
                        <label for="cvv_tarjeta" class="form-label">CVV/CVC</label>
                        <input type="text" class="form-control" id="cvv_tarjeta" required minlength="3" maxlength="4"
                            placeholder="Ej: 123">
                    </div>
                </div>

                <button type="submit" class="btn btn-accept w-100">Confirmar Compra</button>
            </form>
        </div>
    </div>

    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel"><i class="bi bi-check-circle-fill me-2"></i> ¬°Compra
                        Exitosa!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>‚úÖ Tu pedido ha sido procesado.</p>
                    <hr>
                    <p>Confirmaci√≥n del env√≠o:</p>
                    <p>A nombre de: <strong id="modalNombre"></strong></p>
                    <p>Direcci√≥n de env√≠o: <strong id="modalDireccion"></strong></p>
                    <hr>
                    <p>Compra verificada con la tarjeta: <strong id="modalTarjetaMask"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-accept" data-bs-dismiss="modal">Aceptar y Continuar</button>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h5>üéÆ Gamer Zone</h5>
                    <p>La mejor tienda online de videojuegos y accesorios.</p>
                    <p><i class="bi bi-geo-alt-fill me-2"></i> Calle Principal #123, Ciudad Gamer</p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>Enlaces R√°pidos</h5>
                    <ul class="list-unstyled">
                        <li><a href="productos.html" class="text-white text-decoration-none">Cat√°logo Completo</a></li>
                        <li><a href="ofertas.html" class="text-white text-decoration-none">Ver Ofertas</a></li>
                        <li><a href="noticias.html" class="text-white text-decoration-none">√öltimas Noticias</a></li>
                        <li><a href="sobre-nosotros.html" class="text-white text-decoration-none">Sobre Nosotros</a>
                        </li>
                        <li><a href="login2.html" class="text-white text-decoration-none">Mi Cuenta</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3">
                    <h5>S√≠guenos</h5>
                    <a href="#" class="text-white me-3"><i class="bi bi-facebook fs-4"></i></a>
                    <a href="#" class="text-white me-3"><i class="bi bi-twitter fs-4"></i></a>
                    <a href="#" class="text-white"><i class="bi bi-instagram fs-4"></i></a>
                </div>
            </div>
            <div class="row">
                <div class="col-12 text-center pt-3 border-top border-light opacity-50">
                    <p class="mb-0">&copy; 2025 Gamer Zone. Todos los derechos reservados. | Proyecto de Dise√±o Web.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/sesion.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const registroForm = document.getElementById('registroForm');
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));

            const passwordField = document.getElementById('password');
            const passwordGroup = document.getElementById('passwordGroup');
            const loggedMessage = document.getElementById('loggedMessage');

            // --- L√ìGICA DE PRECARGA DE DATOS (Checkea si ya se inici√≥ sesi√≥n en login2.html) ---
            const emailSesion = localStorage.getItem('usuarioEmail');
            const sesionIniciada = localStorage.getItem('sesionIniciada') === 'true';

            if (sesionIniciada && emailSesion) {
                console.log(`Sesi√≥n activa para: ${emailSesion}. Intentando precargar datos...`);

                // Ocultar campo de contrase√±a y marcar como no requerido
                if (passwordGroup) {
                    passwordField.required = false;
                    passwordGroup.style.display = 'none'; // Ocultar todo el grupo de contrase√±a
                }

                // Llamar al endpoint del servidor para obtener los datos del usuario
                fetch(`https://backend-pagina-production.up.railway.app/obtener-datos-usuario?email=${emailSesion}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.usuario) {
                            const user = data.usuario;

                            // 1. Rellenar campos de cuenta/env√≠o (dividir nombre_completo)
                            const nombreCompleto = user.nombre_completo || '';
                            const nombreParts = nombreCompleto.split(/\s+/); // Divide por espacios

                            // Intenta asignar la primera palabra a nombres y el resto a apellidos
                            const nombres = nombreParts.shift() || '';
                            const apellidos = nombreParts.join(' ') || '';

                            document.getElementById('nombres').value = nombres;
                            document.getElementById('apellidos').value = apellidos;
                            document.getElementById('direccion').value = user.direccion || '';
                            document.getElementById('email').value = user.email || '';

                            // 2. Rellenar datos de tarjeta (si existen)
                            document.getElementById('nombre_titular_tarjeta').value = user.nombre_titular_tarjeta || '';
                            document.getElementById('numero_tarjeta').value = user.numero_tarjeta || '';
                            document.getElementById('caducidad_tarjeta').value = user.caducidad_tarjeta || '';
                            document.getElementById('cvv_tarjeta').value = user.cvv_tarjeta || '';

                            // Mostrar mensaje de logueado
                            if (loggedMessage && passwordGroup) {
                                passwordGroup.style.display = 'block'; // Mostrar de nuevo el contenedor para el mensaje
                                loggedMessage.style.display = 'block';
                            }
                            console.log("Datos precargados con √©xito.");

                        } else {
                            console.log("Usuario logueado, pero el servidor no encontr√≥ datos detallados o fall√≥ la precarga.");
                        }
                    })
                    .catch(error => {
                        console.error('Error al precargar datos:', error);
                        alert('Error al conectar con el servidor para precargar tus datos.');
                    });
            } else {
                console.log("Sesi√≥n no activa. El usuario debe registrarse y proveer contrase√±a.");
            }
            // --- FIN L√ìGICA DE PRECARGA DE DATOS ---


            if (registroForm) {
                registroForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // 1. Recopilar TODOS los datos (incluyendo tarjeta)
                    const nombres = document.getElementById('nombres').value;
                    const apellidos = document.getElementById('apellidos').value;
                    const direccion = document.getElementById('direccion').value;
                    const email = document.getElementById('email').value;

                    // La contrase√±a solo se env√≠a si el campo no est√° deshabilitado/oculto y es requerido
                    const password = passwordField.required ? passwordField.value : '';

                    const nombre_titular_tarjeta = document.getElementById('nombre_titular_tarjeta').value;
                    const numero_tarjeta = document.getElementById('numero_tarjeta').value;
                    const caducidad_tarjeta = document.getElementById('caducidad_tarjeta').value;
                    const cvv_tarjeta = document.getElementById('cvv_tarjeta').value;

                    // 2. Crear el objeto JSON para enviar al servidor.
                    const data = {
                        nombres,
                        apellidos,
                        direccion,
                        email,
                        password, // Se env√≠a vac√≠o si el usuario ya est√° logueado
                        nombre_titular_tarjeta,
                        numero_tarjeta,
                        caducidad_tarjeta,
                        cvv_tarjeta
                    };

                    try {
                        // Enviamos todos los datos a la ruta /registro (maneja INSERT o UPDATE)
                        const response = await fetch('https://backend-pagina-production.up.railway.app/registro', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data),
                        });

                        const result = await response.json();

                        // Status 201 (creaci√≥n) o 200 (actualizaci√≥n)
                        if (response.status === 201 || response.status === 200) {

                            // L√≥gica para enmascarar el n√∫mero de tarjeta 
                            let tarjetaEnmascarada = '**** **** **** ****';
                            if (numero_tarjeta && numero_tarjeta.length >= 4) {
                                const ultimosCuatro = numero_tarjeta.substring(numero_tarjeta.length - 4);
                                tarjetaEnmascarada = `**** **** **** ${ultimosCuatro}`;
                            }

                            // 1. Rellenar los datos en el Modal
                            const nombreCompletoUsuario = result.nombre_completo || `${nombres} ${apellidos}`;

                            document.getElementById('modalNombre').textContent = nombreCompletoUsuario;
                            document.getElementById('modalDireccion').textContent = direccion;
                            document.getElementById('modalTarjetaMask').textContent = tarjetaEnmascarada;


                            // 2. Ocultar el formulario y mostrar el Modal
                            document.querySelector('.login-card').style.display = 'none';
                            successModal.show();

                            // 3. Guardar sesi√≥n (siempre actualizamos la sesi√≥n al completar una compra exitosa)
                            if (result.nombre_completo) {
                                localStorage.setItem('usuarioNombre', result.nombre_completo);
                                localStorage.setItem('sesionIniciada', 'true');
                                localStorage.setItem('usuarioEmail', email);
                            }

                        } else {
                            alert('‚ùå Error al procesar la compra: ' + result.message);
                        }

                    } catch (error) {
                        console.error('Error de conexi√≥n con el servidor:', error);
                        alert('‚ùå Error de conexi√≥n. Aseg√∫rate que el servidor Express.js est√© corriendo en el puerto 3000.');
                    }
                });
            }

            // Evento para redirigir a index.html cuando el modal se cierra (el usuario presiona Aceptar o la X)
            document.getElementById('successModal').addEventListener('hidden.bs.modal', function () {
                if (registroForm) {
                    registroForm.reset();
                }
                window.location.href = 'index.html';
            });
        });
    </script>
</body>

</html>